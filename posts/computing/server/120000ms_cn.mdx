---
date: "2023-06-01"
title: "120000 æ¯«ç§’ Linux æ€§èƒ½åˆ†æ"
summary: "ä¸€äº›æ€§èƒ½é—®é¢˜æ’æŸ¥ç”¨åˆ°çš„å°å·¥å…·"
---

å¯å‘ä¸æ„Ÿè°¢ï¼š[Linux Performance Analysis in 60,000 Milliseconds](https://netflixtechblog.com/linux-performance-analysis-in-60-000-milliseconds-accc10403c55)

ä¸Šè¾¹é“¾æ¥æ˜¯ç³»ç»Ÿæ€§èƒ½å·¥ç¨‹å¸ˆå¤§ç¥Brendan Greggå†™çš„æ–‡ç« ï¼Œæè¿°åœ¨é‡åˆ°Linuxæ€§èƒ½é—®é¢˜å‰60ç§’ä¼šæ€ä¹ˆæ’æŸ¥ã€‚
æˆ‘å…ˆç®€å•æ€»ç»“ä»–æ‰€æè¿°çš„å·¥å…·ï¼Œåœ¨é™„åŠ ä¸€äº›è‡ªå·±çš„ç»éªŒã€‚

## 60000 æ¯«ç§’å†…å¹²ä»€ä¹ˆ
1. `uptime`
    - ä¸»è¦çœ‹ä¸åŒæ—¶é—´çš„ load averageï¼Œçœ‹çœ‹ç³»ç»Ÿæ˜¯å¦è¶Šæ¥è¶Šå¿™ã€‚
    - load æŒ‡çš„æ˜¯1ï¼Œ5ï¼Œ15åˆ†é’Ÿå¹³å‡æœ‰å¤šå°‘ä»»åŠ¡åœ¨ç­‰å¾…CPUã€‚
3. `dmesg | tail`
    - çœ‹æœ€å10æ¡ç³»ç»Ÿæ—¥å¿—ã€‚
5. `vmstat 1` Virtual Memory Statistics
    - æ¯”è¾ƒé‡è¦çš„ä¿¡æ¯æ˜¯`si` `so`, swap ins and swap outs. å¦‚æœè¿™æ˜¯ä¸æ˜¯0ï¼Œè¯´æ˜ç³»ç»Ÿå¼€å§‹ä½¿ç”¨swapã€‚swapæ¯”RAMæ…¢å¾ˆå¤šï¼Œç³»ç»Ÿå¾ˆå¯èƒ½çœ‹ä¸Šå»åƒæ­»æœºäº†ã€‚
    - çœ‹å†…å­˜ä¿¡æ¯ç”¨`free -h`æ¯”è¾ƒ user friendlyã€‚
    - å…¶ä»–å…³äºCPUçš„å‡½æ•°ï¼š`us` (user time), `sy` (system/kernel time), `id` (idle time), `wa` (wait IO time), `st` (stolen time æ¯”è¾ƒå°‘è§)
    - å‘½ä»¤ä¸­`1`æŒ‡çš„æ˜¯æ›´æ–°å»¶è¿Ÿã€‚
7. `mpstat -P ALL 1` MultiProcessor Statistics
    - `-P ALL` æ˜¯æŒ‡æ‰€æœ‰çš„CPUï¼Œä¹Ÿå¯ä»¥`-P 1`
    - `1`æ˜¯æ›´æ–°å»¶è¿Ÿ
    - è·Ÿvmstatå·®ä¸å¤šï¼Œåªä¸è¿‡æ²¡æœ‰memoryæ•°æ®ã€‚
9. `pidstat 1` PID Statistics
    - `1`æ˜¯æ›´æ–°å»¶è¿Ÿï¼Œæœ‰ç‚¹åƒ`top`ã€‚
    - æ¯”è¾ƒæ–¹ä¾¿ï¼Œå¯ä»¥å§outputå­˜åˆ°æ–‡ä»¶é‡Œæˆ–è€…grep
12. `iostat -xz 1`
    - `-x` æ˜¾ç¤ºæ‰€æœ‰æ•°æ®
    - `-z` ä¸æ˜¾ç¤ºæ²¡æœ‰æ´»åŠ¨çš„è®¾å¤‡
    - `r/s w/s rkB/s wkB/s`ï¼šreads per second, writes per second, read kb per second, written kb per second.
    - `await` å¹³å‡ç­‰å¾…IOçš„æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ã€‚
    - `avgqu-sz` average queue size å‘è®¾å¤‡å‘å‡ºçš„å¹³å‡è¯·æ±‚æ•°ã€‚
    - `%util` æ¯ç§’è®¾å¤‡èŠ±è´¹åœ¨å·¥ä½œçš„ç™¾åˆ†æ¯”ã€‚
14. `free`
    - å¯ä»¥å¢åŠ `-h`æ”¹æˆhuman readable format
    - æ£€æŸ¥æœ‰å‰©ä½™ï¼ˆfreeï¼‰çš„å†…å­˜
    - `buffers`å’Œ`cached`ä¼šè¢«IOä½¿ç”¨ï¼Œå¦‚æœè¿™ä¸ªæ•°ç›®æ¥è¿‘0ï¼ŒIOä¼šæœ‰æ€§èƒ½é—®é¢˜ã€‚
16. `sar -n DEV 1` System Activity Report
    - `-n DEV` æ˜¾ç¤ºç½‘ç»œè®¾å¤‡çš„æ•°æ®
    - `1` æ˜¯æ›´æ–°å»¶è¿Ÿ
    - å¯ä»¥çœ‹ç½‘å¡æ˜¯å¦é¥±å’Œã€‚
    - `%ifutil` interface utilization ä¸ä¸€å®šå‡†ç¡®ï¼Œå¯èƒ½æ˜¾ç¤º0.0
    - rxkB/s receive kB/s
    - txkB/s transmit kB/s
18. `sar -n TCP,ETCP 1`
    - TCP æ•°æ®
    - `active/s` locally-initiated connections per second,
    - `passive/s`remotely-initiated connections per second, i.e. accepted connections,
    - `retrans/s`retransmitted connections per second.
20. `top`
    - å¤§å®¶éƒ½çŸ¥é“è¿™ä¸ªæ˜¯ä»€ä¹ˆ

## é—®é¢˜è¯Šæ–­

å½“æœºå™¨é‡åˆ°æ€§èƒ½é—®é¢˜ï¼Œç”¨ä»¥ä¸Šå·¥å…·æ€ä¹ˆåšå‡ºè¯Šæ–­å‘¢ï¼Ÿ
ä¸€èˆ¬é—®é¢˜èƒ½åˆ†ç±»æˆä¸€ä¸‹ä¸‰ç§
1. CPU
2. IO
3. Network

### CPU

å¯ä»¥ä»ç³»ç»Ÿloadçœ‹å‡ºã€‚è¿™æ ·ä¸€çœ‹`top`å°±èƒ½çŸ¥é“æ˜¯å“ªä¸ªæœåŠ¡åœ¨åƒCPUï¼Œå¹¶å¯ä»¥é€‰æ‹©killæ‰ã€‚

å¦‚æœä»`vmstat`æˆ–`mpstast`çœ‹å‡ºsystem timeå¾ˆé«˜ï¼Œå¯ä»¥æ€€ç–‘CPUé—®é¢˜æœ‰å¯èƒ½æ˜¯IOé€ æˆçš„ã€‚

ä¸€èˆ¬CPUæ…¢åªä¼šé€ æˆç³»ç»Ÿæ…¢ä¸‹æ¥ï¼Œä¸ä¼šå®Œå…¨å¡ä½ã€‚å¦‚æœä¸€ä¸ªç³»ç»Ÿå®Œå…¨å¡ä½äº†ï¼Œä¸€èˆ¬æˆ‘ä¼šæ€€ç–‘æ˜¯å†…å­˜ä¸å¤Ÿï¼Œç³»ç»Ÿåœ¨swapæˆ–è€…[thrashing](https://en.wikipedia.org/wiki/Thrashing_(computer_science))ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹å¯èƒ½sshæˆ–è€…topéƒ½æ…¢çš„ä¸å¾—äº†ï¼Œå»ºè®®ç›´æ¥æ‹”ç”µæº ğŸ˜¼ã€‚

### IO

å¯ä»¥æ£€æŸ¥`iostat`. å¦‚æœ`%util`é è¿‘100%ï¼Œé‚£ä¹ˆå°±æ˜¯IOè®¾å¤‡å¿™ä¸è¿‡æ¥äº†ã€‚è¿™é‡Œåƒå¤§å®¶æ¨èä¸€ä¸ª`iotop`å·¥å…·ï¼ˆå¯èƒ½éœ€è¦å®‰è£…ï¼Œè€Œä¸”éœ€è¦sudoè¿è¡Œï¼‰ï¼Œè¿™ä¸ªå·¥å…·å°±æ˜¯IOä¸–ç•Œçš„`top`ï¼Œå¯ä»¥å¸®å¿™æŸ¥çœ‹æ˜¯ä»€ä¹ˆä»»åŠ¡åœ¨åˆ©ç”¨å¤šå°‘IOã€‚

![image.png](https://p0-bytetech-private.bytetech.info/tos-cn-i-93o7bpds8j/3e51fc760e7f4cb69e5517cd3b0f4cea~tplv-93o7bpds8j-compressed.awebp?policy=eyJ2bSI6MiwiY2siOiJieXRldGVjaCJ9&x-orig-authkey=f32326d3454f2ac7e96d3d06cdbb035152127018&x-orig-expires=1688790339&x-orig-sign=g0iSoX4DGozbkB40OXOjo2jncMY%3D)

è¿™æ˜¯æˆ‘è‡ªå·±ç”µè„‘ä¸Šè¿è¡Œçš„ï¼Œå¯è§å¤§éƒ¨åˆ†IOæ˜¯transmissioné€ æˆçš„ï¼Œä½†450K/sä¸æ˜¯é—®é¢˜ã€‚

### Network

å¯èƒ½æœåŠ¡å™¨å®Œå…¨æ­£å¸¸ï¼Œåªæ˜¯ç½‘ç»œæŒ‚æ‰äº†ã€‚
å¦‚æœåœ¨è¿™ç§æƒ…å†µä¸‹ä½ è¿˜èƒ½`ssh`åˆ°æœºå™¨å†…ï¼Œå¯ä»¥çœ‹`sar -n DEV`çš„è¾“å‡ºã€‚ä¸»è¦çœ‹`rx`å’Œ`tx`æ˜¯ä¸æ˜¯è¿‡é«˜ã€‚å¦‚æœä½ çŸ¥é“ç½‘å¡æ˜¯1Gçš„ï¼Œè€Œå…¶ä¸­ä¸€ä¸ªæ•°ç›®å·²ç»æ¥è¿‘1Gï¼Œé‚£æ˜¾ç¤ºç½‘å¡å¯èƒ½é¥±å’Œäº†ï¼Œé€ æˆæ€§èƒ½é—®é¢˜ã€‚å¦‚æœçœ‹`sar -n TCP`ï¼Œæœ‰å¤§é‡çš„retransï¼Œè¯´æ˜ç½‘ç»œä¸ç¨³å®šï¼Œæœ‰é“¾æ¥é—®é¢˜ã€‚é“¾æ¥é—®é¢˜ä¹Ÿæœ‰å¯èƒ½æ˜¯å¯¹æ–¹æœåŠ¡è¶…è½½ä¸èƒ½åŠæ—¶å›å¤ï¼Œä¸ä¸€å®šæ˜¯ç½‘ç»œå‡ºé”™ã€‚

è¿™é‡Œä¹Ÿä»‹ç»ä¸€ä¸ª`iftop`ï¼ˆä¹Ÿéœ€è¦å®‰è£…ï¼Œä¹Ÿéœ€è¦sudoï¼‰ï¼Œæ˜¾ç¤ºnetwork activity by hostï¼Œå¯ä»¥çœ‹å‡ºä»€ä¹ˆé“¾æ¥åˆ©ç”¨networkingæ¯”è¾ƒå¤šã€‚

![image.png](https://p0-bytetech-private.bytetech.info/tos-cn-i-93o7bpds8j/53c4464d6cd24878bfdb9d5639fc6f54~tplv-93o7bpds8j-compressed.awebp?policy=eyJ2bSI6MiwiY2siOiJieXRldGVjaCJ9&x-orig-authkey=f32326d3454f2ac7e96d3d06cdbb035152127018&x-orig-expires=1688790339&x-orig-sign=KaNC3BMvdkieTbby5GYDLRai7hM%3D)

ä¹Ÿæœ‰ä¸€ä¸ª`ifstat`(éœ€è¦å®‰è£…ï¼Œä¸éœ€è¦sudoï¼‰å·¥å…·ï¼Œè·Ÿiostatå’ŒvmstatåŠŸèƒ½ä¸€æ ·ã€‚
